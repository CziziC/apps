### 1. 新增用户
### 1.1. 注册企业
- 企业名称将更新到注册企业的工作区名称。
- 邮箱地址如果已存在，则不允许注册。
- 企业名称即工作区名称允许重复存在，且同一用户可能存在多个同名工作区。

### 1.2. 组织架构中邀请用户【拟去掉该功能】
- 通过邮件批量邀请用户，关联字段[emails.address]。
- 如果被邀请的用户[emails.address]在平台数据库中不存在，则会新建一个用户，并加入到space_users表中，但用户信息是空的。
- 如果被邀请的用户[emails.address]在平台数据库中已存在，则不会新建用户，只会把已存在的用户加入到space_users表中，其中用户信息规则为：users表中的姓名、手机号(mobile)会同步到新的工作区信息space_users表中。

> 在1.5节中【新增用户是否同意加入工作区相关】，该功能有BUG，即邀请用户后space_users.invite_state属性值没有设置为pending，而是直接加入新工作区了，除非保留该功能，否则不修正该BUG。


### 1.3. 组织架构/通讯录中添加成员
- 邮箱地址或手机号两个必填一个。
- 通过字段[emails.address或phone.number]查找邮箱地址或手机号关联用户，如果用户已存在，则直接把该用户加入新工作区。
- 如果邮箱地址和手机号都填写了，并且关联到两个不同的用户时，则提示错误不允许添加。
- 如果新添加的用户在平台数据库中不存在，则会新建一个用户，并加入到space_users表中，且通讯录space_users表中数据与个人信息users表中数据一致。
- 如果新添加的用户在平台数据库中已存在，则不会新建用户，只会把已存在的用户加入到space_users表中，其中用户信息规则如下：

    A. space_users表中新增用户的姓名、手机号、邮箱是从users表中同步到的数据，而不是新增用户时填写的信息。

    B. 如果users表中同步到的手机号为空，则space_users表中手机号也会被清空，反之会从users表中同步手机号值到space_users表中。

    C. 如果users表中同步到的邮箱(emails及email)为空，则space_users表中邮箱也会被清空，反之会从users表中同步email或emails.address中第一个值到space_users表中。

    D. 除上述姓名、手机号、邮箱外，其他像职务、固定电话、所属部门、上级主管、单位(company)等信息都是新增用户时新填写的数据。
    
    E. 添加成员时填写的任何信息都不会同步到users表中。

### 1.4. 组织架构/通讯录中导入用户
- 在真正导入用户之前，会对用户填写的数据进行初步校验，如果发现信息有误，则不会进行数据导入，先提示用户具体第几行的数据信息有误，校验的规则如下：
    
    A. 只有付费版工作区才能使用导入功能，并且导入之后的人员数量不能超过工作区已购买的用户名额。

    B. 邮箱地址或手机号两个必填一个。

    C. 所导入的数据中，邮箱地址或手机号都不能重复出现，邮箱格式要符合正规。

    D. 通过字段`[username,emails.address,phone.number]`在users表中查找用户，如果查找数量大于1个，则提示错误信息，“第X行，用户名、手机号、邮箱信息有误，无法匹配到同一账号”。

    E. 部门字段不能为空，根部门名称必须是当前工作区的根部门名称，子部门需要用“/”分割，参考格式如下（“根部门/子部门”），“/”之后的子部门名称不能为空。

- 完成以上数据校验之后进行数据导入（相关数据库操作），流程如下：
    
    A. 对用户填写的部门进行查找，如果没有找到该部门，则新建。

    B. 如果未在users表中找到信息匹配的用户，则根据用户名，邮件，手机号对应users表的`username,emails,phone`字段，新建一个用户。

    C. 根据邮件，手机号对应space_users表的`email,mobile`字段，查找该用户是否已在此工作区，如果已存在，则根据用户填写的其他字段，更新该用户的相关信息。如果不存在，则根据相关信息将用户添加到space_users表中。

    D. 对于已经在users表中的用户（已注册过的用户），在添加到space_users时，默认标记`invite_state`为`pending`，`user_accepted`为`false`，表示该用户需要接受邀请才能真正加入到该工作区。对于不在users表中的用户（没有注册过的用户）,默认标记`invite_state`为`accepted`，`user_accepted`为`true`，表示该用户已经加入到该工作区。

    E. 用户导入的更新操作，需要判断当前用户的`invite_state`不为`pending`或`refused`，即该用户已经同意加入到工作区时，才能进行个人信息的更新。

    F. 在数据导入完成之后，页面会弹出一个sweet-alert的modal，内容是导入的结果，会告诉用户一共导入了多少条信息，成功多少条，失败多少条，并且将具体哪条数据失败，失败的原因显示出来。


### 1.5. 新增用户是否同意加入工作区相关
- 新增的用户在users表中不存在时，规则为：
    
    A. 以上任何方式添加的新用户，都不会收到“是否要加入工作区”的弹框提醒，而是直接进入该工作区了。

    B. 注册企业添加的用户，组织架构/通讯录中导入/添加的成员，space_users.invite_state属性值均会被设置为accepted。

- 新增的用户在users表中存在时，规则为：
    
    A. 以上任何方式添加的新用户，都会收到“是否要加入工作区”的弹框提醒，且space_users.invite_state属性值会被设置为pending。
    
    B. 如果新用户在“是否要加入工作区”的弹框提醒中同意，则space_users.invite_state属性值会被设置为accepted，即表示同意进入工作区，反之则属性值会被设置为refused，表示不同意进入工作区。
    
    C. 新用户在“是否要加入工作区”的弹框提醒中同意之前，该用户是无法在工作区列表中看到这个工作区的，并且新工作区中包括工作区管理员在内的任何用户都无法在包括组织架构/通讯录在内的任何界面编辑该用户信息。
    
    D. 如果用户拒绝加入新工作区，space_users.invite_state属性值会立刻被设置为refused，而且以后再也不会弹出这个提醒框了，如果用户还想加入这个工作区，可以让管理员在通讯录中点击“再次邀请”按钮让用户重新看到提醒框。

> 用户在“是否要加入工作区”的弹框提醒中点击拒绝表示用户不想进入新工作区，space_users.invite_state属性值会立刻被设置为refused，但是点击esc关闭窗口表示暂时不处理，刷新或下次进入系统时会再次收到弹窗提示。

> space_users.invite_state属性值为pending时组织架构/通讯录中该用户标记为蓝色，且不能编辑用户信息。

> space_users.invite_state属性值为refused时组织架构/通讯录中该用户标记为红色，且不能编辑用户信息。

> space_users.invite_state属性值为accepted时组织架构/通讯录中该用户不做任何特别标记，且可以编辑用户信息。


### 2. 修改用户
### 2.1. 个人信息中修改用户
- 用户可以在自己的账户信息中修改姓名、语言、头像等基本信息。
- 用户可以在自己的账户信息绑定手机号，更改用户名及密码等登录信息，见本文节点5。
- 修改后，姓名、手机号会同步到通讯录信息space_users中。
- 可以添加、删除、设置主要邮件，规则见小节5.2。

### 2.2. 组织架构/通讯录中修改用户
- 修改手机号相关规则见5.1.3。
- 只有工作区管理员(组织管理员不可以)可以在通讯录中查看和修改用户的用户名。
- 管理员修改姓名会同步到users表及space_users表的所有工作区信息中。
- 管理员修改职务、固定电话、单位(company)字段(包括把值清空)时，只会修改space_users表中当前工作区的单位信息，不会同步其值到其他工作区并且其值也不会同步到users表中。
- 用户所属组织的编辑权限有特别规则，见本文节点3.2。
- 用户邮件修改规则见小节5.2。

> 只有专业版工作区管理员才可以编辑用户的手机号码。????

> 因只有用户自己接受进入工作区的账户才可以在通讯录中被管理员修改用户信息，所以手机号、用户名等重要信息被管理员修改不存在安全隐患。

### 3. 移动用户
### 3.1. 方法
- 组织架构/通讯录中拖动用户来移动用户到另一个组织。
- 组织架构/通讯录中直接编辑用户所属部门属性来移动用户到另一个组织。

### 3.2. 相关规则
- 工作区管理员可以把任何用户拖动或修改到任何组织。
- 如果不是工作区管理员，则无论是拖动用户还是直接编辑用户所属部门，都需要对修改前用户所属组织中至少一个组织有组织管理员权限，但是不需要对要移动到的目标组织有组织管理员权限。

### 4. 删除用户
### 3.1. 方法
- 只能在组织架构/通讯录中删除用户，删除用户即是从工作区是移除用户，而不会删除用户的Steedos账户。
- 用户自己退出工作区。【未开发】

### 3.2. 相关规则
- 组织架构/通讯录中工作区管理员可以删除用户整个工作区中任何用户。
- 组织架构/通讯录中组织管理员可以删除其管辖范围内任何用户。

> 删除用户只会把用户从space_users表中删除，不会删除users表中数据，被删除的用户仍然可以登录和使用Steedos系统，只是不能进入被删除用户的工作区。

### 5. 登录及相关字段
### 5.1. 手机号
### 5.1.1. 登录规则
- 手机号与手机短信验证码登录。
- 手机号与密码登录。【未开发】
- 手机号不需要验证通过就可以登录。
- 如果是用手机短信验证码登录，则在登录成功后，会自动设置当前手机号为验证通过。

### 5.1.2. 绑定手机号
- 如果短信验证未通过，不会变更或保存任何有效信息。
- 如果短信验证通过，会把手机号增加前缀+86存入users.phone.number字段中，且会额外记录下验证已通过，即设置phone.verified为true。
- 绑定手机号时，当且仅当验证通过后，检测到手机号如果在users.phone.number中已存在时，不管该手机号是否验证通过，都会直接清除其手机号相关信息，且其账户下users.phone,users.mobile,及全部工作区下的space_users.mobile属性都会清除。
- 绑定手机号时，当且仅当验证通过后，绑定的手机号才会同步到users.mobile字段(去除前缀+86)，并且会进一步同步到当前用户所在所有工作区的信息中，即同步到space_users.mobile中。

### 5.1.3. 通讯录中修改手机号规则
- 当新手机号在其他用户的users.phone.number中已存在时，不管该手机号是否验证通过，都会提示用户已存在。
- 手机号未验证通过情况下才允许管理员修改，否则手机号不允许修改。??????
- 会把新的手机号同步到users.phone.number，并设置users.phone.is_verified=false，即每次手机号变更需要用户自己去重新验证手机号。
- 不会把新手机号同步到users.mobile中，并且会把users.mobile清除掉，即新的手机号验证通过前，老的users.mobile中手机号无法接收催办等各种短信通知。
- 会进一步把新手机号同步到所有工作区的信息中，即同步到space_users.mobile中。
- 新的手机号验证通过前，除了手机短信验证码登录功能可以正常使用外，手机短信验证码找回密码等依赖手机验证的功能都不能用。
- 会给修改前及修改后的手机号各发一条短信通知手机号已被管理员修改。
- 如果手机号被设置为空，会直接清除users.phone、users.mobile及space_users.mobile中的数据，并且老的users.mobile中的手机号会收到手机号已被管理员设置为空的通知短信。
- 当未配置settings.public.phone字段时，会直接把新手机号(包括设置为空)同步到users.mobile及space_users.mobile中。??????

### 5.1.4. 其他规则
- 只有验证通过的手机号才可以用手机短信验证码找回密码功能。
- 只有验证通过的手机号users.phone.number才会同步到users.mobile，也才可以收到如催办等各种短信通知（因为其用的是users.mobile）。
- 管理员才能在组织架构/通讯录中修改手机号。
- 整个系统中手机号users.phone.number不允许重复，users.mobile是同步自users.phone.number，所以也不会重复，也不允许重复。

>当未配置settings.public.phone字段时，包括绑定手机号在内的上述手机号相关功能全部不存在，但是手机号与密码登录这个功能不受配置影响。??????

### 5.2. 邮件
### 5.2.1. 登录规则
- 邮件未验证情况下是可以通过该邮件加密码登录系统。
- 登录邮件用的是user.emails.address，而不是user.email字段值。
- user.emails.address中如果有多个地址，则都可以用于登录。


### 5.2.2. 个人信息中修改邮件规则
- 用户自己可以在自己的账户设置界面添加、删除邮件，但是不能删除主要邮件。
- 只有用户自己可以设置主要邮件，且只能设置一个主要邮件（users.email），默认users.email是空值。
- 邮件能设置为主要邮件前提是该邮件已通过验证。
- 用户如果设置了主要邮件，主要邮件会同步到通讯录的邮件space_users.email中。
- 验证邮件通过时，当且仅当用户只有一个邮箱时,自动设置为主要邮箱，反之需要用户手动设置主要邮件。

### 5.2.3. 通讯录中修改邮件规则
- 如果当前用户存在任何一个已验证邮箱，则通讯录中不能修改邮箱。
- 如果当前用户不存在已验证邮箱，会清除users.emails.address所有未验证过的地址，并且把修改后的邮件地址加到users.address中，但是状态为未验证，同时把新邮件同步到所有工作区信息space_users.email中。

### 5.2.4. 其他规则
- 只有主要邮件的邮件才会被作为接收系统发送信息的邮件。
- 通讯录中的邮件space_users.email值默认是注册时users.emails.address中第一个。
- 整个系统中users.emails.address/users.email两个属性都不允许重复。
- 邮件不区分大小写，所有的邮件都会强制转成小写。


### 5.3. 用户名
### 5.3.1. 登录规则
- 用户名加密码可以登录系统。

### 5.3.2. 其他规则
- 用户自己可以在个人信息中修改用户名。
- 工作区管理员可以在组织架构/通讯录中修改用户名。
- 整个系统中用户名username不允许重复。
- 用户名不区分大小写，所有的用户名都会强制转成小写。



