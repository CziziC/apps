### 1.功能背景
为实现【开发组织架构设置权限功能：A组的成员设置为可查看B组成员信息。#1352】,参考企业微信中限制查看外部门功能。

### 2.设置方法
- 设置菜单路径：系统设置>高级设置>通讯录权限>限制查看外部门。
- 设置界面会列出已设置限制规则列表，列表中只显示被限制的部门名称，而不显示额外可见部门名称，默认属性下被限制的部门，只能看到本部门的通讯录。
- 在添加/修改界面可以设置哪些部门受限制查看外部门（第一个选组控件），设置后这些部门内的用户只能看到自己所在部门内的通讯录信息。
- 在添加/修改界面设置了哪些部门受限制查看外部门的基础上，可以进一步设置其可额外查看到的部门（第二个选组控件）,设置后受限部门就能额外查看这些部门的通讯录信息。
- 允许为限制查看外部门设置多条限制规则，每条规则中限制部门属性必填，额外查看部门可以为空，当其为空时表示只需要限制其只能看到自己所在部门内的通讯录信息，而不需要额外查看其他部门的通讯录信息。
- 当不需要某条规则时，可以在设置界面删除掉。
- 可以为每个工作区设置自己的限制规则。
- 只有工作区管理员才能进行该设置。

> 上述设置中的两个选组控件的作用范围都是包含子组织的范围的，比如选中A组织就代表选中A组织及其下属所有组织，并不需要一层一层选下去。

> 可以设置组织构架根目录为限制部门，这样整个组织构架内任何用户都只能看到自己所在部门内的通讯录信息。

> 设置界面的规则列表是实时订阅的，多个用户同时编辑时可以实时看到其他用户的保存结果。


### 3.应用规则
### 3.1. 管理员相关规则
- 只有工作区管理员不受上述所设置的规则限制，其他任何用户都需要应用上述规则。
- 组织管理员如果有额外查看部门权限，那么在新增及修改用户时，用户所属组织属性也可以设置成额外部门，这应该是不合理的，后续考虑优化，参考企业微信。

### 3.2. 当前用户所属组织只有一个时
- 只要这个组织出现在上述设置的限制规则中任何一条规则中的受限部门之一，则其肯定被限制只能看到本部门的通讯录，反之能看整个通讯录信息。
- 当设置了多条规则时，多条规则下的额外可查看部门合在一起，就变成当前用户可额外查看的部门。

### 3.3. 当前用户所属组织有多个时
- 按3.1的规则，每个所属组织都要单独检查是否被限制只能看到本部门的通讯录，只要一个所属组织不被限制，则能看整个通讯录信息，反之说明当前用户只能看到本部门的通讯录。
- 按3.1的规则，查出每个所属组织额外可查看部门，它们再次合在一起，就变成当前用户可额外查看的部门。

> 即使当前用户所属的多个组织本身存在父子包含关系时，也适用3.2的规则。

> 用户登录后，会根据上述设置界面中设置的规则，判断出当前用户是否被限制查看外部门，并且如果是的话，会计算并记住其额外可查看哪些部门。

> 如果计算出当前用户额外可查看的部门中存在父子包含关系，或者当前用户额外可查看的部门与当前用户所属部门之间存在父子包含关系时，以最外层组织范围为准，且组织树或列表第一层只能显示最外层组织，而不会把有包含关系的部门并列列在一起。

> 可以在浏览器控制台通过输入Steedos.my_contacts_limit查看计算当前用户是否限制查看外部门的结果：
```
Steedos.my_contacts_limit
{
	isLimit: true, //是否限制查看外部门
	outside_organizations: []//除当前用户所属组织外可额外查看的外部门
}
```

### 3.4 限制查看外部门规则变化时，应用时同步规则
- 第一次进入系统时会计算并记住当前用户在当前工作区的限制查看外部门规则。
- 每次刷新浏览器时会重新计算当前用户在当前工作区的限制查看外部门规则。
- 切换工作区时，会重新计算当前用户在切换后的工作区的限制查看外部门规则。

> 上面说的计算并记住“限制查看外部门规则”，指的是当前用户在某个工作区是否被限制查看外部门及其额外可查看哪些部门。

> 除了上述的同步规则外，当限制查看外部门规则变化时，其所应用的规则会是变化前的规则，除非用户刷新浏览器、切换工作区或重新打开系统，否则新的规则永远应用不上。

> 是否同步完成可以通过`Session.get("is_my_contacts_limit_loaded")`值来判断，以此来解决有时数据没有加载完成，就应用了上述规则的问题。

> 当上述限制查看外部门规则数据没有加载完成或者加载失败时，则会应用默认规则：统一限制在本单位范围，并且不能查看任何额外组织信息。

### 3.5. 与隐藏组织冲突时的规则
- 当设置的限制查看外部门规则中额外组织存在隐藏组织时，该额外组织设置对普通用户来说是无效的，即优先隐藏那些被设置为隐藏组织属性的组织，而不是显示出来，但是如果用户本身就有权限查看隐藏组织，那么这个额外组织设置还是有效的。

> 隐藏组织的功能自成一脉，其优先级别更高。

### 3.6. 与主部门冲突时的规则
- 主部门单独拿出来显示在最上面，它是一棵独立的树结构，只会有一个根节点。
- 主部门以外其他部门显示全在主部门树后面，也是一棵独立的树结构，但是根据当前用户的权限（比如文本提到的限制外部门规则），可能存在多个根节点。
- 当主部门树与下面的树根节点重复时，即主部门树下面的树的根节点包括主部门时，只会显示一个主部门根节点，即主部门树下面的树中的主部门如果也在根节点的话是不显示出来的。
- 只有选人选组控件才会额外把主部门单独拿出来显示在最上面，通讯录中没有这个规则，即只显示上述第二棵树结构。

### 4. 应用范围
- PC版通讯录及系统设置中组织架构。
- 手机版通讯录及系统设置中组织架构。
- 所有地方的选人选组控件。
